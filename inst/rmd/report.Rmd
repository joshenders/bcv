---
title: "Locations report"
output: html_document
params:
  which_days: !r Sys.Date()
  unique_id: 2
  date: !r Sys.Date()
  credentials_file: 'credentials/credentials.yaml'
---

```{r setup, include=FALSE}
library(httr)
library(tidyverse)
library(leaflet)
library(yaml)
library(bcv)
# Basic knitr options
library(knitr)
opts_chunk$set(comment = NA, 
               echo = FALSE,
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE,
               fig.width = 8,
               fig.height = 6)
```

```{r, eval = TRUE}
# # Read in credentials from file path
creds <- params$credentials_file
ok <- file.exists(creds)
if(!ok){
  message('No credentials file found at ', creds)
} else {
  message('Using credentials file at ', creds)
  credentials <- yaml::yaml.load_file(unlist(creds))
}
## Alternative approach: pass object itself
# credentials <- params$credentials
```


```{r}

# Get locations data
df <- get_positions_from_unique_id(url = credentials$traccar_url, 
                                   user = credentials$traccar_user,
                                   pass = credentials$traccar_pass,
                                   unique_id = params$unique_id)

# Get person data
person <- bcv::get_registered_workers(dbname = credentials$dbname,
                                      host = credentials$host,
                                      user = credentials$user,
                                      pass = credentials$pass,
                                      port = credentials$port,
                                      unique_id =params$unique_id)

# Get reports using a unique id to fetch device id: possible reports - trips, summary, stops, route, events

# by trips - each row is a single "trip" with start and stop lat/lon for a given unique id
reports_trips <- get_reports_from_unique_id(url = credentials$traccar_url,
                             user = credentials$traccar_user,
                             pass = credentials$traccar_pass,
                             report_type = 'trips',
                             unique_id = params$unique_id)

# by stops - each row is a reported stop with details on position and time idle. the positionId column can be linked to the startPositionId and endPositionId in "trips"
reports_stops <- get_reports_from_unique_id(url = credentials$traccar_url,
                             user = credentials$traccar_user,
                             pass = credentials$traccar_pass,
                             report_type = 'stops',
                             unique_id = params$unique_id)

```

```{r}

# get dates without time
df$date <- as.Date(strftime(df$deviceTime, tz = 'UTC', format = "%Y-%m-%d"))

# get hours
df$hour <- strftime(df$deviceTime, tz = 'UTC', format = "%H")

# this function takes the locations data frame and arguments to show all days, a subset of days, or one day (in this case it visualizes the hour of the day instead of the date)
get_worker_routes <- function(df = df, all_days, which_days = params$which_days){
  # define a color function
  colfunc <- colorRampPalette(c("yellow", "red"))

  if(all_days){
    # get colors  
    df$colors <- colfunc(nrow(df))
    # create a dataframe for the leaflet legend
    time_legend <- df %>% group_by(date) %>% summarise(counts = n())
    time_legend$colors <- colfunc(nrow(time_legend))
    plot_title <- 'Routes for all days available'
    
    # create plot
    m <- leaflet(data = df) %>%
      addTiles() %>%  # Add default OpenStreetMap map tiles
      addCircleMarkers(color = ~colors) %>%
      addPolylines(data = df, lng=~longitude, lat=~latitude, weight = 1) %>%
      addLegend(data = time_legend, 'bottomright', colors = ~colors, labels = ~date, title = plot_title)
    
  } else {
    # subset data by which_days
    days_string <- paste0(which_days, collapse = '|')
    df_days <- df %>% filter(grepl(days_string, date))
    df_days$colors <- colfunc(nrow(df_days))
    m <- leaflet(data = df_days) %>%
      addTiles() %>%  # Add default OpenStreetMap map tiles
      addCircleMarkers(color = ~colors) %>%
      addPolylines(data = df_days, lng=~longitude, lat=~latitude, weight = 1)
    
    # if more than one date chosen visualize dates, otherwise visualize hours
    if(length(which_days) > 1){
      # create a dataframe for the leaflet legend
      time_legend <- df_days %>% group_by(date) %>% summarise(counts = n())
      time_legend$colors <- colfunc(nrow(time_legend))
      plot_title <- paste0('Routes for ')
      m <- m %>%   addLegend(data = time_legend, 'bottomright', colors = ~colors, labels = ~date, title = plot_title)
    } else {
      time_legend <- df_days %>% group_by(hour) %>% summarise(counts = n())
      time_legend$colors <- colfunc(nrow(time_legend)) 
      plot_title <- paste0('All routes for ', which_days, ' by hour')
      time_legend$hour <- paste0(time_legend$hour, ':00 UTC')
      m <- m %>%   addLegend(data = time_legend, 'bottomright', colors = ~colors, labels = ~hour, title = plot_title)
    }
  }
  return(m)
}

```

## All days of tracking history
```{r}
get_worker_routes(df = df, all_days = TRUE)
```

## One or multiple days of tracking history

```{r}
get_worker_routes(df = df, all_days = FALSE)
```


```{r}
# define a color function
colfunc <- colorRampPalette(c("yellow", "red"))

# convert startime to date object
new_start_time <- gsub(pattern = 'T', replacement = ' ', reports_stops$startTime)
reports_stops$startTime <- as.POSIXct(new_start_time, tz = 'UTC', format = '%Y-%m-%d %H:%M:%S')

new_end_time <- gsub(pattern = 'T', replacement = ' ', reports_stops$endTime)
reports_stops$endTime <- as.POSIXct(new_end_time, tz = 'UTC', format = '%Y-%m-%d %H:%M:%S')

# createa a new duration column (currently duration column in ambiguous format)
reports_stops$new_duration <- as.numeric(reports_stops$endTime - reports_stops$startTime)

# get dates without time
reports_stops$date <- as.Date(strftime(reports_stops$startTime, tz = 'UTC', format = "%Y-%m-%d"))

# get hours
reports_stops$hour <- strftime(reports_stops$startTime, tz = 'UTC', format = "%H")

# create a variable called duration_label to visualize on the map
reports_stops$duration_label <- paste0(round(reports_stops$new_duration/60), ' min')
      

# convert lat/lon to numeric
reports_stops$latitude <- as.numeric(reports_stops$latitude)
reports_stops$longitude <- as.numeric(reports_stops$longitude)

# this function takes the reports_stops data frame and arguments to show all days, a subset of days, or one day (in this case it visualizes the hour of the day instead of the date)
get_worker_stops <- function(dat = reports_stops, all_days = TRUE, which_days = params$which_days){
  if(all_days){
    # get colors  
    dat$colors <- colfunc(nrow(dat))
    # create a dataframe for the leaflet legend
    time_legend <- dat %>% group_by(date) %>% summarise(counts = n())
    time_legend$colors <- colfunc(nrow(time_legend))
    plot_title <- 'All days available'
    m <- leaflet(data = dat) %>%
      addTiles() %>%  # Add default OpenStreetMap map tiles
      addCircleMarkers(lng=~longitude, lat=~latitude, color = ~colors, radius = ~sqrt(new_duration)) %>%
      addLegend(data = time_legend, 'bottomright', colors = ~colors, labels = ~date, title = plot_title)
  } else {
    # if more than one date chosen, show dates, otherwise hours
    if(length(which_days) > 1){
      # subset by days
      days_string <- paste0(which_days, collapse = '|')
      dat_days <- dat %>% filter(grepl(days_string, date))
      # create data frame to get unique color for each day (hacky)
      color_data <- data_frame(colors = colfunc(length(which_days)), date = as.Date(which_days))
      # join with data
      dat_days <- left_join(dat_days, color_data, by ='date' )  
      # create dataframe for legend
      time_legend <- dat_days %>% group_by(date) %>% summarise(counts = n())
      time_legend$colors <- colfunc(nrow(time_legend))
      plot_title <- paste0('All stops for ')
      m <- leaflet(data = dat_days) %>%
        addTiles() %>%  # Add default OpenStreetMap map tiles
        addCircleMarkers(lng=~longitude, lat=~latitude,color = ~colors, radius = ~sqrt(new_duration), label = ~duration_label,  labelOptions = labelOptions(noHide = T, direction = 'top')) %>% 
        addLegend(data = time_legend, 'bottomright', colors = ~colors, labels = ~date, title = plot_title)
      
    } else {
      # subset by day
      days_string <- paste0(which_days, collapse = '|')
      dat_days <- dat %>% filter(grepl(days_string, date))
      
      # create dataframe for legend
      time_legend <- dat_days %>% group_by(hour) %>% summarise(counts = n())
      time_legend$colors <- colfunc(nrow(time_legend)) 
      plot_title <- paste0('All stops for ', which_days, ' by hour')
      dat_days$colors <- colfunc(nrow(dat_days))
      time_legend$hour <- paste0(time_legend$hour, ':00 UTC')
      
      m <- leaflet(data = dat_days) %>%
        addTiles() %>%  # Add default OpenStreetMap map tiles
        addCircleMarkers(lng=~longitude, lat=~latitude,radius = ~sqrt(new_duration), color = ~colors, label = ~duration_label,  labelOptions = labelOptions(noHide = T, direction = 'top')) %>% 
        addLegend(data = time_legend, 'bottomright', colors = time_legend$colors, labels = time_legend$hour,title = plot_title)
    }
  }
  return(m)
}

```

## All stops since tracking started

```{r}
get_worker_stops(dat = reports_stops, all_days = TRUE)
```

## All stops from a subset of days

```{r}
get_worker_stops(dat = reports_stops, all_days = FALSE)
```
